{#
/**
 * @file
 * Template for Media Album Light Table with Field Groups.
 *
 * Available variables:
 * - view: The view object.
 * - groups: Hierarchical array of grouped media.
 * - options: Style plugin options including field_groups configuration.
 */
#}

{# Extract variables from options for cleaner code #}
{% set columns = options.columns|default(4) %}
{% set gap = options.gap|default('20px') %}
{% set justify = options.justify|default('flex-start') %}
{% set align = options.align|default('stretch') %}
{% set field_mapping_config = options.field_mapping|default({}) %}

{# Macro to render media items with field groups #}
{% macro render_media_item(media_item, columns, gap, field_mapping_config, view) %}
  {% set infos = media_item.media %}
  {% set thumbnail = media_item.thumbnail %}
  {% set image_alt = infos.fields.name|default('') %}

  {% set row_index = media_item.row_index %}

  <div class="draggable-flexgrid__item media-item js-draggable-item"
       data-entity-id="{{ infos.id }}"
       data-id="{{ infos.id }}"
       data-media-id="{{ infos.id }}"
       style="flex: 0 0 calc(100% / {{ columns }} - {{ gap }});">

    {# Main content area with groups #}
    <div class="draggable-flexgrid__content">

      {# Thumbnail Field #}
      {% if field_mapping_config.thumbnail.enabled %}
        <div class="draggable-flexgrid__group-1 media-light-table-thumbnail-field">
          <div class="draggable-flexgrid__thumbnail media-light-table-thumbnail">
          <span class="field-content media-light-field-content">
            <img
              src="{{ thumbnail.thumbnail_url }}"
              alt="{{ image_alt }}"
              title="{{ infos.label }}"
              width="{{ thumbnail.thumbnail_width }}"
              height="{{ thumbnail.thumbnail_height }}"
              class="draggable-flexgrid__image media-light-table-image" />
          </span>
          </div>
        </div>
      {% endif %}

      {# Name Field #}
      {% if field_mapping_config.name.enabled %}
        <div class="draggable-flexgrid__group-3 media-light-table-name-field">
          {# Rendre le vrai champ name #}
          <span class="field-content media-light-field-content">
          {{ view.style_plugin.getField(row_index, field_mapping_config.name.field) }}
          </span>
        </div>
      {% endif %}

      {# VBO Actions Field #}
      {% if field_mapping_config.vbo.enabled %}
        <div class="draggable-flexgrid__group-2 media-light-table-vbo-field">
          <span class="field-content media-light-field-content">
          {# Rendre le vrai champ VBO #}
          {{ view.style_plugin.getField(row_index, field_mapping_config.vbo.field) }}
          </span>
        </div>
      {% endif %}

      {# Action Field #}
      {% if field_mapping_config.action.enabled %}
        <div class="draggable-flexgrid__group-5 media-light-table-action-field">
          <span class="field-content media-light-field-content">
          {# Rendre le vrai champ action #}
          {{ view.style_plugin.getField(row_index, field_mapping_config.action.field) }}
          </span>
        </div>
      {% endif %}

      {# Media Details - reste inchangé #}
      {% if field_mapping_config.details.enabled %}
        <div class="media-light-table-info-wrapper media-light-table-details-field" data-once="entity-popup">
          <button type="button" class="media-light-table-info-button">{{ 'More...'|t }}</button>
          <div class="media-light-table-info-popup">
            <span class="media-light-table-image-id media-light-table-popup-field">
              <strong>{{ 'ID'|t }}:</strong> {{ infos.id }}
            </span>
            <span class="media-light-table-image-filepath media-light-table-popup-field">
              <strong>{{ 'Path'|t }}:</strong> {{ infos.file_path }}
            </span>
            <span class="media-light-table-image-size media-light-table-popup-field">
              <strong>{{ 'Size'|t }}:</strong> {{ (infos.size_bytes / 1024 / 1024)|round(2) }} MB
            </span>
            <span class="media-light-table-image-mime-type media-light-table-popup-field">
              <strong>{{ 'MIME'|t }}:</strong> {{ infos.mime_type }}
            </span>
            {% if infos.width > 0 and infos.height > 0 %}
              <span class="media-light-table-image-dimensions media-light-table-popup-field">
                <strong>{{ 'Dimensions'|t }}:</strong> {{ infos.width }}x{{ infos.height }}
              </span>
            {% endif %}
            <span class="media-light-table-image-name media-light-table-popup-field">
              <strong>{{ 'Name'|t }}:</strong> {{ infos.file_name }}
            </span>
            {% if infos.bundle %}
              <span class="media-light-table-image-bundle media-light-table-popup-field">
                <strong>{{ 'Media Type'|t }}:</strong> {{ infos.bundle }}
              </span>
            {% endif %}
          </div>
        </div>
      {% endif %}
    </div>

    {# Right side menu: drag handle and zoom button #}
    <div class="draggable-flexgrid__menu-handle" title="{{ 'Action menu'|t }}">
      <div class="media-light-table-drag-icon draggable-flexgrid__menu-button draggable-flexgrid__handle" title="{{ 'Drag to reorder'|t }}">
        <svg class="drag-icon" width="1.8rem" height="1.8rem" viewBox="0 0 32 32" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          {# Arrows positioned at extremes #}
          {# Top #}
          <line x1="16" y1="6" x2="16" y2="14"/>
          <polyline points="12,10 16,6 20,10"/>
          {# Bottom #}
          <line x1="16" y1="26" x2="16" y2="18"/>
          <polyline points="12,22 16,26 20,22"/>
          {# Left #}
          <line x1="6" y1="16" x2="14" y2="16"/>
          <polyline points="10,12 6,16 10,20"/>
          {# Right #}
          <line x1="26" y1="16" x2="18" y2="16"/>
          <polyline points="22,12 26,16 22,20"/>
        </svg>
      </div>
      <div class="media-light-table-zoom-trigger draggable-flexgrid__menu-button"
        role="button"
        tabindex="0"
        title="{{ 'View full size'|t }}"
        aria-label="{{ 'View full size'|t }}"
        data-image-src="{{ infos.url }}"
        data-image-alt="{{ image_alt }}"
        data-mime-type="{{ infos.mime_type }}"
        data-media-type="{{ infos.mime_type|split('/')|first }}">
        <svg class="zoom-icon" width="1.8rem" height="1.8rem" viewBox="0 0 32 32" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <circle cx="11" cy="11" r="8"/>
          <line x1="19" y1="19" x2="28" y2="28" stroke-width="3"/>
          <line x1="18" y1="20" x2="27" y2="29" stroke-width="1.5" opacity="0.8"/>
          <line x1="11" y1="7" x2="11" y2="15"/>
          <line x1="7" y1="11" x2="15" y2="11"/>
        </svg>
      </div>
    </div>

  </div>
{% endmacro %}

{# Macro to render albums in grids #}
{% macro render_albums(albums, columns, gap, field_mapping_config, view, display_group = true) %}
{# display the album container only if display_group is true or if there are medias in the album #}
  {% if display_group == true or albums|length > 0 %}
    {% if albums|length == 0 %}
      <div class="draggable-flexgrid__grid media-grid media-light-table-album-container js-draggable-flexgrid empty-state"
          data-album-id="empty-album"
          data-columns="{{ columns }}"
          data-gap="{{ gap }}"
          style="display: flex; flex-wrap: wrap; gap: {{ gap }}; min-height: 50px;">
      </div>
    {% else %}
      {% for album in albums %}
        <div class="draggable-flexgrid__grid media-grid media-light-table-album-container js-draggable-flexgrid{% if not album.medias %} empty-state{% endif %}"
            data-album-id="{{ album.id }}"
            data-columns="{{ columns }}"
            data-gap="{{ gap }}"
            style="display: flex; flex-wrap: wrap; gap: {{ gap }}; min-height: 120px;">
          {% if album.medias %}
            {% for media_item in album.medias %}
              {# Passer view et row_index à la macro #}
              {{ _self.render_media_item(media_item, columns, gap, field_mapping_config, view) }}
            {% endfor %}
          {% endif %}
        </div>
      {% endfor %}
    {% endif %}
  {% else %}
    {{ '' }}
  {% endif %}
{% endmacro %}

{# Macro to recursively render groups #}
{% macro render_group_recursive(group, columns, gap, field_mapping_config, view) %}
    {# strip tags and trim to check if title is empty #}
    {% if group.title|striptags|trim|length != 0 %}
      <div class="draggable-flexgrid__group-title media-light-table-group-title" data-level="{{ group.level }}">
        {{ group.title }}
      </div>
      {% set display_group = true %}
    {% else %}
      {% set display_group = false %}
    {% endif %}

       {# Render albums at this level #}
       {{ _self.render_albums(group.albums|default([]), columns, gap, field_mapping_config, view, display_group) }}

  {# Render subgroups recursively #}
  {% if group.subgroups %}
    {% for subgroup in group.subgroups %}
      <div class="draggable-flexgrid__subgroup media-light-table-subgroup">
        {{ _self.render_group_recursive(subgroup, columns, gap, field_mapping_config, view) }}
      </div>
    {% endfor %}
  {% endif %}
{% endmacro %}

{# Main container #}
{{dump()  }}
<form {{ attributes }}>
{# form for VBO to work properly #}

  <div class="draggable-flexgrid light-table-content draggable-flexgrid draggable-flexgrid--{{ columns }}cols js-draggable-flexgrid"
      data-view-id="{{ view.id }}"
      data-display-id="{{ view.current_display }}"
      data-columns="{{ columns }}"
      data-gap="{{ gap }}"
      style="display: flex; flex-wrap: wrap; gap: {{ gap }}; justify-content: {{ justify }}; align-items: {{ align }};">

  <input type="hidden" name="media-light-table-vbo-order" class="media-light-table-vbo-order" value="">

    {% if groups is empty %}
      <div class="draggable-flexgrid__empty">
        {{ 'No content available.'|t }}
      </div>
    {% else %}
      {% for group in groups %}
        <div class="draggable-flexgrid__group-container media-light-table-group">
          {{ _self.render_group_recursive(group, columns, gap, field_mapping_config, view) }}
        </div>
      {% endfor %}
    {% endif %}
  </div>
</form>
